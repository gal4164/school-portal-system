<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Tools - School Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">← Back to Dashboard</a>
            <span class="text-white">Admin Tools</span>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Quick Setup Tools</h2>
        <p class="text-muted">Use these tools to assign teachers to classes and enroll students</p>

        <div class="row mt-4">
            <!-- Assign Teacher to Class -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Assign Teacher to Class</h5>
                    </div>
                    <div class="card-body">
                        <form id="assignTeacherForm">
                            <div class="mb-3">
                                <label class="form-label">Teacher</label>
                                <select class="form-select" id="teacherSelect" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Class</label>
                                <select class="form-select" id="classSelectTeacher" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subject</label>
                                <input type="text" class="form-control" id="subject" placeholder="e.g., Mathematics">
                            </div>
                            <button type="submit" class="btn btn-primary">Assign Teacher</button>
                        </form>
                        <div id="assignResult" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Enroll Student in Class -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Enroll Student in Class</h5>
                    </div>
                    <div class="card-body">
                        <form id="enrollStudentForm">
                            <div class="mb-3">
                                <label class="form-label">Student</label>
                                <select class="form-select" id="studentSelect" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Class</label>
                                <select class="form-select" id="classSelectStudent" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">Enroll Student</button>
                        </form>
                        <div id="enrollResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Assignments -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Current Assignments</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-sm btn-secondary mb-3" onclick="loadAssignments()">Refresh</button>
                        <div id="assignmentsList">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
        }

        const API_BASE = '/api';

        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(`${API_BASE}${endpoint}`, options);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Request failed');
            }
            
            return data;
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTeachers();
            await loadStudents();
            await loadClasses();
            await loadAssignments();

            document.getElementById('assignTeacherForm').addEventListener('submit', assignTeacher);
            document.getElementById('enrollStudentForm').addEventListener('submit', enrollStudent);
        });

        async function loadTeachers() {
            try {
                const data = await apiCall('/admin/teachers');
                const select = document.getElementById('teacherSelect');
                select.innerHTML = '<option value="">Select Teacher</option>' +
                    data.teachers.map(t => `<option value="${t.id}">${t.first_name} ${t.last_name} (${t.email})</option>`).join('');
            } catch (error) {
                console.error('Error loading teachers:', error);
            }
        }

        async function loadStudents() {
            try {
                const data = await apiCall('/admin/students');
                const select = document.getElementById('studentSelect');
                select.innerHTML = '<option value="">Select Student</option>' +
                    data.students.map(s => `<option value="${s.id}">${s.first_name} ${s.last_name} (${s.email})</option>`).join('');
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        async function loadClasses() {
            try {
                const data = await apiCall('/admin/classes');
                const html = '<option value="">Select Class</option>' +
                    data.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                document.getElementById('classSelectTeacher').innerHTML = html;
                document.getElementById('classSelectStudent').innerHTML = html;
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function assignTeacher(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('assignResult');
            
            try {
                const data = {
                    teacher_id: parseInt(document.getElementById('teacherSelect').value),
                    class_id: parseInt(document.getElementById('classSelectTeacher').value),
                    subject: document.getElementById('subject').value
                };

                const result = await apiCall('/admin/assign-teacher', 'POST', data);
                resultDiv.innerHTML = '<div class="alert alert-success">✓ Teacher assigned successfully!</div>';
                setTimeout(() => resultDiv.innerHTML = '', 3000);
                await loadAssignments();
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">✗ Error: ${error.message}</div>`;
            }
        }

        async function enrollStudent(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('enrollResult');
            
            try {
                const data = {
                    student_id: parseInt(document.getElementById('studentSelect').value),
                    class_id: parseInt(document.getElementById('classSelectStudent').value)
                };

                const result = await apiCall('/admin/enroll-student', 'POST', data);
                resultDiv.innerHTML = '<div class="alert alert-success">✓ Student enrolled successfully!</div>';
                setTimeout(() => resultDiv.innerHTML = '', 3000);
                await loadAssignments();
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">✗ Error: ${error.message}</div>`;
            }
        }

        async function loadAssignments() {
            const div = document.getElementById('assignmentsList');
            try {
                const teachers = await apiCall('/admin/teachers');
                const students = await apiCall('/admin/students');
                const classes = await apiCall('/admin/classes');

                let html = '<h6>Teacher Assignments:</h6><ul class="list-group mb-3">';
                // This is a simplified view - in production you'd query the actual assignments
                html += '<li class="list-group-item text-muted">Use the forms above to create assignments</li>';
                html += '</ul>';

                html += '<h6>Student Enrollments:</h6><ul class="list-group">';
                html += '<li class="list-group-item text-muted">Use the forms above to enroll students</li>';
                html += '</ul>';

                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = '<div class="alert alert-danger">Error loading assignments</div>';
            }
        }
    </script>
</body>
</html>
